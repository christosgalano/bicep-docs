version: '3'

tasks:
  #### Default ####
  default:
    desc: List all tasks
    cmds:
      - task -l
    silent: true

  #### Utility ####
  setup:
    desc: Run all setup tasks
    cmds:
      - task setup:mod
      - task setup:go-tools
    silent: true

  setup:mod:
    desc: Download and tidy Go modules
    aliases:
      - 'mod'
    cmds:
      - go mod download
      - go mod tidy
    silent: true

  setup:go-tools:
    desc: Install necessary Go tools
    aliases:
      - 'tools'
    cmds:
      - go install github.com/mgechev/revive@latest # revive for linting
      - go install golang.org/x/tools/cmd/deadcode@latest # deadcode
      - go install gotest.tools/gotestsum@latest # gotestsum for testing
      - go install github.com/axw/gocov/gocov@latest # gocov for coverage
      - go install github.com/AlekSi/gocov-xml@latest # gocov-xml for coverage
      - go install github.com/securego/gosec/v2/cmd/gosec@latest # gosec for security
    silent: true

  #### Lint ####
  lint:
    desc: Run all lint tasks
    cmds:
      - task lint:fmt
      - task lint:vet
      - task lint:revive
      - task lint:deadcode
    silent: true

  lint:fmt:
    desc: Format code
    aliases:
      - 'fmt'
      - 'format'
    cmds:
      - gofmt -s -w -l .
    silent: true

  lint:vet:
    desc: Vet code
    aliases:
      - 'vet'
    cmds:
      - go vet ./...
    silent: true

  lint:revive:
    desc: Lint code with revive
    aliases:
      - 'rv'
      - 'revive'
    cmds:
      - revive -config revive.toml -formatter friendly ./...
    silent: true

  lint:deadcode:
    desc: Lint code with deadcode
    aliases:
      - 'deadcode'
    cmds:
      - deadcode -test ./...
    silent: true

  #### Test ####
  test:
    desc: Run all tests for all packages
    cmds:
      - printf "---------- markdown ---------------------------------\n\n" && task test:markdown && printf "\n\n"
      - printf "---------- template ---------------------------\n\n" && task test:template && printf "\n\n"
    silent: true

  test:junit:
    desc: Run all tests for all packages and output JUnit XML
    vars:
      FILENAME: test-results.xml
    cmds:
      - task test
      - gotestsum --junitfile {{ .FILENAME }} --junitfile-project-name bicep-docs --junitfile-testcase-classname short --junitfile-testsuite-name short --junitfile-hide-empty-pkg --format-hide-empty-pkg
    silent: true

  test:markdown:
    desc: Run tests for markdown package
    dir: ./internal/markdown
    cmds:
      - gotestsum -f testname
    silent: true

  test:template:
    desc: Run tests for template package
    dir: ./internal/template
    cmds:
      - gotestsum -f testname
    silent: true

  coverage:
    desc: Generate coverage information for all packages
    cmds:
      - gocov test ./... | gocov report
    silent: true

  coverage:junit:
    desc: Generate coverage information for all packages
    vars:
      FILENAME: coverage.xml
    cmds:
      - gocov test ./... | gocov-xml > {{ .FILENAME }}
    silent: true

  coverage:badge:
    desc: Generate coverage badge
    cmds:
      - .github/scripts/coverage-badge.sh

  ### Benchmark###
  benchmark:
    desc: Run benchmarks for template package
    dir: ./internal/template
    cmds:
      - go test -bench=. -benchmem -count 4
    silent: true

  #### Security ####
  security:
    desc: Run all security tasks
    cmds:
      - task security:gosec
    silent: true

  security:gosec:
    desc: Run gosec
    aliases:
      - 'gosec'
    cmds:
      - gosec -exclude=G204,G304 ./internal/...
      - gosec -exclude=G204,G304 ./cmd/...
    silent: true

  #### Build ####
  build:
    desc: Build binary
    cmds:
      - go build -o ./bin/bicep-docs ./cmd/bicep-docs/main.go
    silent: true

  #### Clean ####
  clean:
    desc: Clean binaries
    aliases:
      - 'clean'
    cmds:
      - rm ./bin/bicep-docs 2> /dev/null
      - rm -rf ./dist 2> /dev/null
    silent: true
    ignore_error: true
